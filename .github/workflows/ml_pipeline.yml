name: GITHUB ACTIONS CICD-DOCKER

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}  # Ensure this is the actual JSON key
  ARTIFACT_REGISTRY_URL: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-repo/credit-prediction
  IMAGE_TAG: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-repo/credit-prediction:v1.0
  REGION: us-central1

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v3

      # Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flask pytest

  build-and-publish:
    needs: build-and-test
    runs-on: ubuntu-latest

    steps:
      # Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v3

      # Set up Google Cloud Authentication using the service account key
      - name: Set up Google Cloud SDK and authenticate
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          credentials_json: ${{ secrets.GCP_SA_KEY }}  # Use secret for authentication

      # Install DVC
      - name: Install DVC
        run: |
          pip3 install dvc[gcp]

      # Authenticate DVC with the Google Cloud service account
      - name: DVC authentication
        run: |
          dvc remote modify myremote --local gdrive_use_service_account true
          dvc remote modify myremote --local gdrive_service_account_json ${{ secrets.GCP_SA_KEY }}

      # Run DVC pull (or push)
      - name: DVC pull
        run: dvc pull

      # Debug the environment variables (without exposing sensitive secrets)
      - name: Debug - Check Environment Variables
        run: |
          echo "PROJECT_ID: $PROJECT_ID"
          echo "ARTIFACT_REGISTRY_URL: $ARTIFACT_REGISTRY_URL"
          echo "IMAGE_TAG: $IMAGE_TAG"

      # Authenticate Docker to use Artifact Registry
      - name: Configure Docker with Artifact Registry
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev

      # Set up Docker Buildx for multi-platform builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Build Docker image
      - name: Build Docker image
        run: |
          docker build -t ${{ env.IMAGE_TAG }} .

      # Push Docker image to Artifact Registry
      - name: Push Docker image to Artifact Registry
        run: |
          docker push ${{ env.IMAGE_TAG }}

      # Deploy to Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy credit-prediction \
            --image ${{ env.IMAGE_TAG }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated
