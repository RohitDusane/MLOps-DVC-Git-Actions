name: ML Pipeline CI/CD

on:
  push:
    branches:
      - main  # Trigger on pushes to the main branch
  pull_request:
    branches:
      - main  # Trigger on pull requests to the main branch

jobs:
  # Job 1: Set up Python environment, install dependencies, and run tests
  build_and_test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'  # Specify Python version

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt  # Make sure your dependencies are listed here

      - name: Run data processing
        run: |
          python src/CreditRisk/components/prepro.py  # Replace with your preprocessing script

      - name: Run model training
        run: |
          python src/CreditRisk/components/train_model.py  # Replace with your training script

      - name: Push to DVC (if applicable)
        run: |
          dvc push  # Push trained model or other large artifacts to DVC

      # - name: Upload model to MLflow
      #   run: |
      #     mlflow models serve --model-uri <MLFLOW_URI>  # Serving model (optional)

  # Job 2: Deploy to GCP App Engine (after successful tests)
  deploy_to_gcp:
    runs-on: ubuntu-latest
    needs: build_and_test  # This job will run only after the build_and_test job succeeds

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set up Google Cloud SDK
        run: |
          curl https://sdk.cloud.google.com | bash
          source $HOME/google-cloud-sdk/path.bash.inc

      - name: Authenticate to GCP
        run: |
          echo "${{ secrets.GCP_SA_KEY }}" > $HOME/gcp-key.json
          gcloud auth activate-service-account --key-file $HOME/gcp-key.json
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

      - name: Deploy to Google Cloud App Engine
        run: |
          gcloud app deploy --quiet  # Deploy the app to App Engine